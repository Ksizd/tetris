Этап: 15.3Ω — Footprint AAA: гравировка в золоте + “сакура‑лава” в каналах
0) ЖЁСТКИЕ ИНВАРИАНТЫ (обязательно)
0.1 Запрещено (под страхом отката)

Запрещены любые “простые” замены лавы на:

PointLight/SpotLight “вдоль кольца”

Points/спрайты как “лава”

LineSegments/LineBasicMaterial как “гравировка”

depthTest=false / renderOrder‑хак, чтобы “рисовалось поверх”

polygonOffset‑хак вместо реальной геометрии

Запрещено делать footprint как просто “наклейку‑плоскость” поверх платформы (оверлей).
Нужна реальная геометрия с глубиной.

0.2 Что обязательно должно быть (геометрия)

Footprint = каналы/гравировка в платформе:

у каналов есть глубина (не нулевая), вертикальные стенки, дно, фаска/скругление кромок (bevel/chamfer), чтобы “вычеканено”.

Footprint должен отражать сетку первого уровня:

две концентрические окружности/канала по радиусам “полосы основания куба”
(ориентир: towerRadius ± blockDepth/2)

радиальные разделители по границам колонок (dimensions.width).

Верх платформы (где стоят кубы) остаётся корректным:

первый этаж кубиков НЕ должен утопать и НЕ должен висеть.

floorY / ringA.topY остаются согласованными.

0.3 Что обязательно должно быть (лава)

“Лава” = не лампочки, а реальная поверхность/объём внутри каналов:

как минимум: отдельная геометрия “дна каналов” + материал лавы.

Материал лавы = анимированный шейдер (ShaderMaterial или onBeforeCompile, но с реальной анимацией):

цвет: сакура‑розовый (ядро) + бело‑розовые “горячие” вспышки + чуть фиолетового/персикового

движение: flow/течение по окружности + микровихри + пульсация

“бульканья”/искры: либо в шейдере (процедурные вспышки), либо лёгкая инстанс‑система частиц СВЕРХУ (но не заменять лаву частицами!)

Лава должна светиться:

emissive/тон‑маппинг: toneMapped=false (или эквивалент) чтобы bloom реально работал

но без сотен источников света.

0.4 Производительность (обязательно)

Никаких 200 отдельных мешей/лайтов вокруг кольца.

Цель: footprint = 1–3 draw call(а):

золото‑каналы (1 mesh)

лава (1 mesh)

(опционально) искры (1 instanced/points, строго лимит по количеству)

Никакой генерации геометрии каждый кадр. Только uTime обновляем.

1) ФАЙЛЫ: что менять, что нельзя трогать
1.1 Трогать можно (и нужно)

src/render/goldenPlatformGeometry.ts
Нужно обеспечить возможность “впекания” footprint‑гравировки (каналы/геометрия) в верх платформы или сделать вырезанный сектор платформы под отдельный inlay‑меш (но без оверлея).

src/render/goldenPlatform.ts
Добавить создание footprint‑inlay как части платформы (или дочерний объект платформы).

src/render/renderer.ts
Убрать/отключить старый “серый дебажный footprint overlay” как основной. Оставить только как debug toggle.

src/render/sceneRenderer.ts
Добавить обновление uTime лавы/FX каждый кадр.

src/render/renderConfig.ts
Добавить флаги: showFootprintInlay, showFootprintRawOverlay, showFootprintLavaFx и т.п.

1.2 Можно добавить новые файлы (лучше так)

src/render/footprintInlayGeometry.ts — генерация геометрии каналов/кромок/дна.

src/render/footprintLavaMaterial.ts — шейдер лавы + параметры.

src/render/footprintInlay.ts — сборка Object3D (gold mesh + lava mesh + опциональные FX).

src/render/footprintLavaFx.ts — искры/пары (опционально, но красиво).

1.3 Запрещено трогать

Камеру и её поведение (НЕ МЕНЯТЬ).

Логику размещения кубов/board state (footprint чисто визуальный).

2) АРХИТЕКТУРА: как именно “не облажаться” с гравировкой

Нужно сделать так, чтобы footprint был частью платформы, а не плавающей наклейкой.

Вариант A (предпочтительный, самый “честный”): “впекание” каналов в геометрию платформы

В goldenPlatformGeometry.ts добавить генерацию каналов прямо в верхней поверхности (RingA top):

в местах каналов делаем “ступеньку” вниз (grooveDepth)

делаем стенки и дно

делаем фаски (bevel) по краям

Для материалов использовать группы:

goldTop (верх)

goldCarve (стенки/фаски чуть темнее/матовее)

lavaBottom (дно каналов — шейдер)

Важно: чтобы сделать каналы “узкими”, нужна локальная детализация сетки.
Значит, RingA top нельзя оставлять супер‑редким: надо добавить “микро‑сегментацию” по углу и радиусу в зоне footprint.

Вариант B (второй по надёжности): “вырезать кольцевую полосу” и вставить inlay‑меш (не оверлей!)

Если Вариант A окажется сложным, делай так:

Платформа (RingA top) делится на 3 радиальные зоны:

innerDisc (до inlayInner)

дырка под inlay (inlayInner..inlayOuter) — НЕ рисуется в платформе

outerDisc (inlayOuter..ringA.outer)

В эту “дырку” вставляется footprintInlay mesh:

верх inlay совпадает по Y с ringA.topY (без пересечений)

каналы внутри inlay реально вырезаны (стенки/дно/фаски)

Это не оверлей, потому что платформа в этом месте отсутствует, а inlay является реальной геометрией поверхности.

3) КОНКРЕТНАЯ ГЕОМЕТРИЯ FOOTPRINT: что должно быть выгравировано
3.1 Радиусы (привязка к сетке)

Используем board:

towerRadius

blockDepth

dimensions.width

Базовая полоса, где стоят кубы:

R0 = towerRadius - blockDepth/2

R1 = towerRadius + blockDepth/2

3.2 Какие каналы вырезаем

Кольцевой канал №1 по R0 (узкий):

ширина: grooveW = blockDepth * 0.06 … 0.10 (клампить, чтобы не стало гигантским)

глубина: grooveD = blockSize * 0.04 … 0.08

Кольцевой канал №2 по R1 (узкий) — симметрично.

Радиальные каналы по границам колонок (i=0..width-1):

шаг по углу: dTheta = 2π / width

каждый канал — узкая “прорезь” по углу вокруг границы (надо дать ей ширину!)

ширину задаём как:

thetaW = (dTheta * 0.08) (и кламп по минимуму, чтобы не исчезало)

радиальный канал соединяет область между R0 и R1 (но не должен разрушать весь пол вокруг).

3.3 Фаски (чтобы это было “вычеканено”, а не Minecraft)

Для каждого канала:

верхняя кромка → фаска вниз (bevelHeight ~ 30–50% от grooveD)

вертикальная стенка

дно

фаска на переходе к дну (микро‑скругление)

Запрещено оставлять “резкий прямоугольный вырез без фаски”.

4) ЛАВА “САКУРА”: только шейдер, только хардкор
4.1 Никаких лампочек — лава должна быть поверхностью

Лава рисуется на “дне каналов” отдельной геометрией (или группой).

4.2 ShaderMaterial: обязательные эффекты

Материал лавы должен:

Иметь uTime и анимировать текстуру процедурно:

flow вдоль окружности (по theta)

внутренние вихри/турбулентность (fbm noise)

Иметь вспышки/горячие точки:

редкие яркие “пульсы” как раскалённые пузырьки

Иметь цветовую палитру:

base: sakura pink

hot: почти белый с розовым

deep: чуть фиолетовый/персиковый

Иметь rim glow у стенок канала:

ближе к краям канала ярче (как свет в стеклянной трубке)

Быть совместимой с bloom:

toneMapped=false

emissive/выходной цвет выше “обычной яркости” (без засвета всей сцены — контролируем коэффициентами)

4.3 UV/координаты

Для лавы удобнее использовать полярные координаты:

thetaNorm = angle / (2π) (0..1)

rNorm внутри канала (0..1)

Так проще делать “течение по кругу”.

5) FX (опционально, но если делаем AAA — делаем как надо)
5.1 Искры/микро‑капли

Только как добавка, не вместо лавы:

1 instanced system:

количество: максимум width * 2 (или фикс лимит типа 64)

каждая искра: маленький quad/plane

анимация: поднимается вверх на 0.1–0.3 блока, исчезает

цвет: бело‑розовый, additive

обновление: только матрицы инстансов + время, без пересоздания мешей.

5.2 Тёплый “пар” над канавками (очень тонко)

Можно сделать 1–2 полупрозрачных кольца (но НЕ “кульки”), слегка шевелящихся:

только если не превращается в мусор

обязательно depthTest=true, без грязных оверлеев.

6) ИНТЕГРАЦИЯ В РЕНДЕР
6.1 Где создаём

При создании платформы (createGoldenPlatform) создаём footprintInlay и добавляем как child.

В renderer.ts НЕ добавляем старый footprintDecor как основной вид. Старый оставить только для debug toggle.

6.2 Где обновляем time

В sceneRenderer.ts в updateScene:

прокидываем time = clock.getElapsedTime()

обновляем lavaMaterial.uniforms.uTime.value = time

обновляем FX (если есть).

7) 3D_HELPER_SYSTEM: тесты, инварианты, дебаг (обязательно!)
7.1 Новые юнит‑тесты (Vitest)

Создай новые тесты:

src/render/__tests__/footprintInlayGeometry.test.ts

boundingBox по Y:
topY ~= floorY (эпсилон)
minY = topY - grooveD - bevelAllowance (и в пределах max)

радиусы каналов попадают в диапазон вокруг R0 и R1

количество сегментов/структура: зависит от width (проверить не ноль, не 2 треугольника)

src/render/__tests__/footprintInlayPlatformIntegration.test.ts

inlay находится внутри ringA и не вылезает за ringB

нет пересечений с башней по “критичным” зонам (хотя бы AABB sanity check)

Если меняешь диагностику:

обнови hallGeometryMonitor так, чтобы footprint мог иметь minY < ringA.topY (это норм для гравировки!)

добавь новый параметр engravingMaxDepth и проверку: ringA.topY - minY <= engravingMaxDepth

7.2 Визуальный debug режим

Добавь debug-переключатели:

showFootprintInlayWireframe

showFootprintLavaUV

disableFootprintLavaAnimation (заморозить time, чтобы фоткать/сравнивать)

И кнопку в debug panel:

“Copy Footprint Inlay Report”:

радиусы R0/R1

grooveW/grooveD

bounding boxes

material params

список мешей/групп + debugTag.kind

8) VISUAL ACCEPTANCE (что я должен увидеть)
8.1 Сверху (top-ish view)

На золотой платформе видно, что footprint не нарисован, а вырезан:

видны канавки (2 кольца + радиальные прорези)

видны фаски/кромки (не плоские линии)

Внутри канавок видна розовая сакура‑лава:

она не точками, а цельным “материалом”

есть движение/мерцание/пульсации (не вращение лампочек по кругу)

Никаких серых дебажных линий/овальных оверлеев.

8.2 Сбоку/под углом (close-up)

Канавка имеет глубину: видны стенки.

Лава лежит на дне (ниже верхнего золота), даёт glow.

При вращении камеры ничего не “ломается”:
нет эффекта, что “это наклейка/спрайт”.

8.3 Игровой смысл

Footprint читается как “разметка куда ставить первый слой”.

Он красивый, но НЕ мешает (не перекрывает кубы, не лезет вверх).

9) План выполнения (маленькие подшаги, без монстра)

Удалить/отключить текущий “лампочко‑footprint” как основной: оставить только debug overlay.

Реализовать геометрию каналов:

сначала только канавки без лавы (goldCarve материал, чтобы видеть форму)

Добавить лаву как отдельную поверхность/материал:

шейдер + uTime

Добавить фаски/улучшить профиль канавки

Подключить bloom‑совместимость (toneMapped=false)

(Опционально) добавить искры/пар инстансами

Обновить диагностику/тесты

Прогнать тесты + сделать скриншоты “до/после” + приложить report из debug панели

Финальное требование

Если результат снова будет “2 линии + 5 огоньков”, это считается провалом и должно быть переделано, пока не станет именно 3D‑гравировкой с шейдерной лавой.